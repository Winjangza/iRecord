#include "MAX31760.h"
#include <QtDebug>
#include "stdio.h"
#include "unistd.h"
#include "stdlib.h"
MAX31760::MAX31760(QObject *parent) : QObject(parent)
{
//    Process = new QProcess;
    i2cDev =  QString ("/dev/i2c-0");
    qDebug() << "MAX31760 i2cDev" << i2cDev;
    ReadWrite = new I2CReadWrite(i2cDev.toStdString().c_str(),MAX31760_MIN_ADDR);
    system("i2ctransfer -y 0 w93@0x54 0x00 0x80 0x11 0x10 0xee 0xce 0x18 0x55 0x00 0x46 0x00 0x6e 0x00 0x32 0x00 0xff 0xff "
                                          "0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa 0xaa 0x55 0x55 0xaa 0xaa 0x55 0x55 "
                                          "0x2a 0x35 0x40 0x4b 0x56 0x61 0x6c 0x77 0x82 0x8d 0x98 0xa3 0xae 0xb9 0xc4 0xcf "
                                          "0xda 0xe5 0xf0 0xfb 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                          "0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                          "0x19 0x6c 0x02 0xff 0x00 0x00 0x00 0x00 0x1b 0x40 0x40 0x1f");
//    system("i2cset -y 0 0x50 0x01 0x11");
//    system("i2cset -y 0 0x50 0x50 0x32");
}
int MAX31760::readFanRpm1()
{
    while(true){
       int n = 2;
        if (i2cDev != "")
        {
            ReadWrite->buffer[0] = MAX31760_TC1H;
            ReadWrite->length = 2;
            ReadWrite->readi2cData();
            uint8_t tach1h = ReadWrite->buffer[0];
            uint8_t tach1l = ReadWrite->buffer[1];
            int Fan_RPM = 60 * ((100000/((tach1h * 256) + tach1l))/n);
            sleep(2);
//            qDebug() << "RPM:" << Fan_RPM << tach1h << tach1l;
//            return Fan_RPM;
        }
//    return 0;
    }
        emit transferdata("transferdata:");
}

int MAX31760::tempDetect(){

    float gputemp = 0;
    float cputemp = 0;
    int count = 0;

    char* cpu;
    char* gpu;
    int n = 2;
    cpu = (char*)malloc(sizeof(char)*6);
    gpu = (char*)malloc(sizeof(char)*6);
    while (true) {

        FILE* fcputemp = fopen("/sys/devices/virtual/thermal/thermal_zone0/temp", "r");
        FILE* fgputemp = fopen("/sys/devices/virtual/thermal/thermal_zone1/temp","r");
        if (!fcputemp || !fgputemp ) {
            qDebug() << "Something went wrong\n";
            exit(EXIT_FAILURE);
        }

        cputemp = atoi(fgets(cpu, 6, fcputemp))/1000;
        gputemp = atoi(fgets(gpu, 6, fgputemp))/1000;

        qDebug() << "\rCpu :"<< cputemp << "Gpu :"  << gputemp;
        fflush(stdout);

        fclose(fcputemp);
        fclose(fgputemp);
        sleep(1);
        if(((cputemp >= 35)&&(cputemp <= 40))){
//            qDebug() << "Fan1";
            system("i2ctransfer -y 0 w93@0x54 0x00 0x80 0x11 0x10 0xee 0xce 0x18 0x55 0x00 0x46 0x00 0x6e 0x00 0x32 0x00 0xff 0xff "
                                                  "0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa 0xaa 0x55 0x55 0xaa 0xaa 0x55 0x55 "
                                                  "0x2a 0x35 0x40 0x4b 0x56 0x61 0x6c 0x77 0x82 0x8d 0x98 0xa3 0xae 0xb9 0xc4 0xcf "
                                                  "0xda 0xe5 0xf0 0xfb 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                                  "0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                                  "0x4B 0x6c 0x02 0xff 0x00 0x00 0x00 0x00 0x1b 0x40 0x40 0x1f");
//            system("i2cset -y 0 0x50 0x50 0x64");
//             system("i2cset -y 0 0x50 0x01 0x11");
            readFanRpm1();
        }else if(((cputemp > 40)&&(cputemp < 45))){
//            qDebug() << "Fan2";
            system("i2ctransfer -y 0 w93@0x54 0x00 0x80 0x11 0x10 0xee 0xce 0x18 0x55 0x00 0x46 0x00 0x6e 0x00 0x32 0x00 0xff 0xff "
                                                  "0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa 0xaa 0x55 0x55 0xaa 0xaa 0x55 0x55 "
                                                  "0x2a 0x35 0x40 0x4b 0x56 0x61 0x6c 0x77 0x82 0x8d 0x98 0xa3 0xae 0xb9 0xc4 0xcf "
                                                  "0xda 0xe5 0xf0 0xfb 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                                  "0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                                  "0x64 0x6c 0x02 0xff 0x00 0x00 0x00 0x00 0x1b 0x40 0x40 0x1f");
//            system("i2cset -y 0 0x50 0x50 0x96");
//             system("i2cset -y 0 0x50 0x01 0x11");
            readFanRpm1();
        }else if(((cputemp > 45)&&(cputemp < 50))){
//            qDebug() << "Fan3";
            system("i2ctransfer -y 0 w93@0x54 0x00 0x80 0x11 0x10 0xee 0xce 0x18 0x55 0x00 0x46 0x00 0x6e 0x00 0x32 0x00 0xff 0xff "
                                                  "0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa 0xaa 0x55 0x55 0xaa 0xaa 0x55 0x55 "
                                                  "0x2a 0x35 0x40 0x4b 0x56 0x61 0x6c 0x77 0x82 0x8d 0x98 0xa3 0xae 0xb9 0xc4 0xcf "
                                                  "0xda 0xe5 0xf0 0xfb 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                                  "0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                                  "0x96 0x6c 0x02 0xff 0x00 0x00 0x00 0x00 0x1b 0x40 0x40 0x1f");
//            system("i2cset -y 0 0x50 0x50 0x78");
//            system("i2cset -y 0 0x50 0x01 0x11");
            readFanRpm1();
        }else if(((cputemp > 50)&&(cputemp < 55))){
//            qDebug() << "Fan4";
            system("i2ctransfer -y 0 w93@0x54 0x00 0x80 0x11 0x10 0xee 0xce 0x18 0x55 0x00 0x46 0x00 0x6e 0x00 0x32 0x00 0xff 0xff "
                                                  "0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa 0xaa 0x55 0x55 0xaa 0xaa 0x55 0x55 "
                                                  "0x2a 0x35 0x40 0x4b 0x56 0x61 0x6c 0x77 0x82 0x8d 0x98 0xa3 0xae 0xb9 0xc4 0xcf "
                                                  "0xda 0xe5 0xf0 0xfb 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                                  "0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                                  "0xC8 0x6c 0x02 0xff 0x00 0x00 0x00 0x00 0x1b 0x40 0x40 0x1f");
//            system("i2cset -y 0 0x50 0x50 0x82");
//             system("i2cset -y 0 0x50 0x01 0x11");
            readFanRpm1();

        }else {
//            qDebug() << "Fan5";
            system("i2ctransfer -y 0 w93@0x54 0x00 0x80 0x11 0x10 0xee 0xce 0x18 0x55 0x00 0x46 0x00 0x6e 0x00 0x32 0x00 0xff 0xff "
                                                  "0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa 0xaa 0x55 0x55 0xaa 0xaa 0x55 0x55 "
                                                  "0x2a 0x35 0x40 0x4b 0x56 0x61 0x6c 0x77 0x82 0x8d 0x98 0xa3 0xae 0xb9 0xc4 0xcf "
                                                  "0xda 0xe5 0xf0 0xfb 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                                  "0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                                  "0xE1 0x6c 0x02 0xff 0x00 0x00 0x00 0x00 0x1b 0x40 0x40 0x1f");
//            system("i2cset -y 0 0x50 0x50 0x82");
//            system("i2cset -y 0 0x50 0x01 0x11");
            readFanRpm1();
        }

    }
}
void MAX31760::safemode(){
    system("i2ctransfer -y 0 w93@0x50 0x00 0x80 0x01 0x10 0xee 0xce 0x18 0x55 0x00 0x46 0x00 0x6e 0x00 0x32 0x00 0xff 0xff "
                                          "0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa 0xaa 0x55 0x55 0xaa 0xaa 0x55 0x55 "
                                          "0x2a 0x35 0x40 0x4b 0x56 0x61 0x6c 0x77 0x82 0x8d 0x98 0xa3 0xae 0xb9 0xc4 0xcf "
                                          "0xda 0xe5 0xf0 0xfb 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                          "0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                          "0x00 0x6c 0x02 0xff 0x00 0x00 0x00 0x00 0x1b 0x40 0x40 0x1f");
    qDebug() << "safe mode";
}
void MAX31760::normalmode(){
    system("i2ctransfer -y 0 w93@0x50 0x00 0x80 0x11 0x10 0xee 0xce 0x18 0x55 0x00 0x46 0x00 0x6e 0x00 0x32 0x00 0xff 0xff "
                                          "0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa 0xaa 0x55 0x55 0xaa 0xaa 0x55 0x55 "
                                          "0x2a 0x35 0x40 0x4b 0x56 0x61 0x6c 0x77 0x82 0x8d 0x98 0xa3 0xae 0xb9 0xc4 0xcf "
                                          "0xda 0xe5 0xf0 0xfb 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                          "0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff "
                                          "0x32 0x6c 0x02 0xff 0x00 0x00 0x00 0x00 0x1b 0x40 0x40 0x1f");
    qDebug() << "Normal mode-----------";
}
QString MAX31760::checkDevice()
{
    QString i2cdev = "/dev/i2c-0";
//    for (int i=0; i<3; i++)
//    {
//        bool i2cDetected = false;
//        QString prog = "/bin/bash";//shell
//        QStringList arguments;
//        arguments << "-c" << QString("i2cdetect -y %1 0x50 0x50 | grep \"50: 50\"").arg(i);
//        Process->start(prog , arguments);
//        Process->waitForFinished();
//        i2cDetected = QString(Process->readAll()).contains("50: 50");
//        arguments.clear();
//        if (i2cDetected)
//        {
//            i2cdev = QString("/dev/i2c-%1").arg(i);
//            break;
//        }
//        if (Process->state() == QProcess::Running){
//            Process->kill();
//            qDebug() << "termenate process";
//        }
//    }
    return i2cdev;
}
